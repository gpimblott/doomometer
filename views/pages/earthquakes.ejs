<?php

require_once ('./db.php');

$conn = mysqli_connect($host, $username, $password, $dbname);
if (mysqli_connect_errno()) {
	echo "Failed to connect to MYSQL: " . mysqli_connect_error();
}

$summaryResult = mysqli_query($conn, "SELECT * from earthquakes_summary_view order by date desc limit 7") or die(mysql_error($conn));

$stmt = NULL;
$date = NULL;

$stmt = mysqli_stmt_init($conn);

if (isset($_GET['date'])) {
	$date = $_GET['date'];
	$query = "SELECT url,description,depth,time from earthquakes where date(time)=? order by magnitude desc limit 30";

	if (mysqli_stmt_prepare($stmt, $query)) {
		mysqli_stmt_bind_param($stmt, "s", $date);
	} else {
		die(mysql_error());
	}
} else {
	$query = "SELECT url,description,depth,time from earthquakes_today_view order by magnitude desc limit 30";
	if (!mysqli_stmt_prepare($stmt, $query)) {
		die(mysql_error());
	}
}

mysqli_stmt_execute($stmt);
mysqli_stmt_store_result($stmt);
mysqli_stmt_bind_result($stmt, $url, $description, $depth, $time);
?>

<?php
include_once $_SERVER['DOCUMENT_ROOT'] . '../trace/api/LogRequest.php';
twatchLogRequest();
?>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN">

<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

		<title>Doomometer - Earthquakes</title>

		<link href="UrbanArtist.css" rel="stylesheet" type="text/css">
		<link rel="shortcut icon" href="doom.ico">

		<script src="scripts/OpenLayers.light.js" type="text/javascript"></script>
		<script src="scripts/popups.js" type="text/javascript"></script>
		<script src="scripts/jquery-1.9.1.min.js" type="text/javascript"></script>

		<style type="text/css">
			#basicMap {
				height: 350px;
				margin: 0;
			}
		</style>

		<script>
			var map;
var quakesLayer;

function init() {
map = new OpenLayers.Map("basicMap");
map.addLayer(new OpenLayers.Layer.OSM());

map.addControl(new OpenLayers.Control.LayerSwitcher());

var styleMap = new OpenLayers.StyleMap({pointRadius: 5 });
var lookup = {
"small": {pointRadius: 2,fillColor: "yellow", fillOpacity: 0.5, strokeColor: "black"},
"medium": {pointRadius: 5,fillColor: "orange", fillOpacity: 0.5, strokeColor: "black"},
"large": {pointRadius: 10,fillColor: "red", fillOpacity: 0.5, strokeColor: "black"},
}

styleMap.addUniqueValueRules("default", "size", lookup);

quakesLayer = new OpenLayers.Layer.Vector('Earthquakes', {styleMap: styleMap});

var features = new Array(0);

<?php

include 'earthquake_data.txt';
?>
	quakesLayer.addFeatures(features);

	map.addLayer(quakesLayer);

	select = new OpenLayers.Control.SelectFeature(quakesLayer);

	quakesLayer.events.on({
		"featureselected" : onFeatureSelect,
		"featureunselected" : onFeatureUnselect
	});

	map.addControl(select);
	select.activate();

	map.zoomToMaxExtent();
	}

		</script>

	</head>

	<body onload="init();">

		<div id="wrap">

			<?php include 'header.html' ?>

			<!-- content-wrap starts -->
			<div id="content-wrap">
				<div id="main">
					<h2>Earthquakes</h2>
					<p>
						<?php

						if (isset($date)) {
							echo "Top " . mysqli_stmt_num_rows($stmt) . " Earthquakes on " .  date("d-m-Y", strtotime($date));
						} else {

							echo "Top " . mysqli_stmt_num_rows($stmt) . " Earthquakes in the last 24 hours. ";
							echo "The average magnitude was " . round($averageMagnitude, 1) . "<br>";
						}
						?>
					</p>
					<table>
						<tr>
							<th>Description</th><th>Depth</th><th>Time</th><th></th>
						</tr>
						<?php
						//mysqli_data_seek($result, 0);
						while (mysqli_stmt_fetch($stmt)) {

							echo "<tr>" . "<td><a href=\"" . $url . "\" target=\"_blank\">" . $description . "</a></td>" . "<td>" . $depth . " km</td>" . "<td>" . date("D H:i", strtotime($time)) . "</td><td>" . "<a href=\"" . $url . "\" target=\"_blank\">View</a></td>" . "</tr>";
						}
						?>
					</table>
				</div>
				<div id="sidebar">
					<h3>Weekly Summary</h3>

					<table>
						<tr>
							<th>Date</th><th>Total earthquakes</th><th>Average Magnitude</th>
						</tr>
						<?php
						while ($row = mysqli_fetch_array($summaryResult)) {
							$date = date("d-m-Y", strtotime($row['date']));
							$linkDate = date("Y-m-d", strtotime($row['date']));
							echo "<tr>" . "<td><a href=\"earthquakes.php?date=" . $linkDate . "\"/>" . $date . "</a></td>" . "<td>" . $row['count'] . "</td>" . "<td>" . round($row['average'], 1) . "</td>" . "<td><a href=\"earthquakes.php?date=" . $linkDate . "\"/>View</a></td>" . "</tr>";
						}
						?>
					</table>
					<h3>Locations</h3>
					<div id="basicMap"></div>
				</div>
				<div id="footer">
					<div id="footer-left">
						<p>
							&copy; copyright G.Pimblott 2013
						</p>
					</div>
					<div id="footer-right">
						<p class="align-right">
							<a href="index.php">Home</a>
							|
							<a href="about.html">About</a>
						</p>
					</div>
				</div>
			</div>

		</div>
	</body>
</html>

<?php
if (isset($stmt)) {
	mysqli_stmt_close($stmt);
}
mysqli_free_result($summaryResult);
mysqli_close($conn);
?>