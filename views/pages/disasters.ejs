<?php

require_once ('./db.php');

$conn=mysqli_connect($host,$username,$password,$dbname);
if(mysqli_connect_errno()) {
	echo "Failed to connect to MYSQL: ".mysqli_connect_error();
}

/** Get the summary information */
$summaryResult=mysqli_query($conn,
	"SELECT * from disasters_summary_view order by date desc limit 7") or die(mysql_error());


$stmt = NULL;
$date = NULL;

$stmt = mysqli_stmt_init($conn);

if (isset($_GET['date'])) {
	$date = $_GET['date'];
	$query = "SELECT url,name,description,fromdate,todate,id,alert_level,longitude,latitude from disasters where date(time)=?";

	if (mysqli_stmt_prepare($stmt, $query)) {
		mysqli_stmt_bind_param($stmt, "s", $date);
	} else {
		die(mysql_error());
	}
} else {
	$query = "SELECT url,name,description,fromdate,todate,id,alert_level,longitude,latitude from disasters_today_view";

	if (!mysqli_stmt_prepare($stmt, $query)) {
		die(mysql_error());
	}
}


mysqli_stmt_execute($stmt);
mysqli_stmt_store_result($stmt);
mysqli_stmt_bind_result($stmt, $url, $name, $description, $fromdate,$todate,
						$id , $alertLevel,$longitude,$latitude);


?>


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN">

<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

		<title>Doomometer - Disasters</title>

		<link href="UrbanArtist.css" rel="stylesheet" type="text/css">
		<link rel="shortcut icon" href="doom.ico">

		<script src="scripts/OpenLayers.light.js" type="text/javascript"></script>
		<script src="scripts/popups.js" type="text/javascript"></script>
		<script src="scripts/jquery-1.9.1.min.js" type="text/javascript"></script>

		<style type="text/css">
			#basicMap {
				height: 350px;
				margin: 0;
			}
		</style>

	
	</head>

	<body onload="init();">
		
		<script>
			var map;
			var disastersLayer;

			function init() {
				map = new OpenLayers.Map("basicMap");
				map.addLayer(new OpenLayers.Layer.OSM());

				map.addControl(new OpenLayers.Control.LayerSwitcher());

				var styleMap = new OpenLayers.StyleMap({pointRadius: 5 });
				var lookup = {
						"Green": {pointRadius: 5,fillColor: "green", fillOpacity: 0.5, strokeColor: "black"},
						"Red": {pointRadius: 5,fillColor: "red", fillOpacity: 0.5, strokeColor: "black"},
				}

				styleMap.addUniqueValueRules("default", "size", lookup);

				disastersLayer = new OpenLayers.Layer.Vector('Disasters', {styleMap: styleMap});

				

			var features = new Array(0);

			<?php
			
			$num=0;
			
			while(mysqli_stmt_fetch($stmt)) {
				
					echo "features[".$num."] = poi(" . $id . "," 
														. "\"".$alertLevel ."\","
														. "\"".$url ."\","
														. "\"".$name ."\","
														.$latitude . ",".$longitude .");\n";
					$num++;
			}
			
			?>
	
			disastersLayer.addFeatures(features);

			map.addLayer(disastersLayer);
			
			select = new OpenLayers.Control.SelectFeature( disastersLayer );
			
			disastersLayer.events.on( { 
				"featureselected": onFeatureSelect,
				"featureunselected": onFeatureUnselect 
				});

			map.addControl(select);
			select.activate();

			map.zoomToMaxExtent();
		}


	</script>
		
		
		<div id="wrap">

			<?php include 'header.html' ?>

			<!-- content-wrap starts -->
			<div id="content-wrap">
				<div id="main">
					<h2>Disasters</h2>
					<p>
						<?php 
						
						if( isset($date)) {
							echo mysqli_stmt_num_rows($stmt) . " Disasters published on " . date("d-m-Y" , strtotime($date));
						} else {
							echo mysqli_stmt_num_rows($stmt) . " Disasters published in the last 24 hours.";
						}
						?>
		
					</p>
					
					
						<?php
						mysqli_stmt_data_seek($stmt, 0);
						while(mysqli_stmt_fetch($stmt)) {
							
							echo "<h3><a href=\"" . $url ."\" target=\"_blank\">" . $name. "</a></h3>";
							echo "<p class='post-info'> From " 
							. date("d-m-Y G:i" , strtotime($fromdate)) . " to " 
							. date("d-m-Y G:i" , strtotime($todate)) . "</p>"; 
							
							echo "<p>" . $description . "</p>"; 
										
						}
						?>
				
				</div>
				<div id="sidebar">
					<h3>Weekly Summary</h3>
					
					<table>
						<tr><th>Date</th><th>Published Disasters</th></tr>
						
						<?php 
						while($row=mysqli_fetch_array($summaryResult)) {
							echo "<tr><td><a href=\"disasters.php?date=" . date("Y-m-d" , strtotime($row['date'])) . "\"/>"
										. date("d-m-Y" , strtotime($row['date'])) 
										. "</a></td><td>"
										. $row['count'] 
										. "</td>" 
										. "<td><a href=\"disasters.php?date=" . date("Y-m-d" , strtotime($row['date'])) . "\"/>View</a></td>" 
										. "</tr>";
						}
						?>
					</table>
					<h3>Locations</h3>
					<div id="basicMap"></div>
				</div>
			
				<?php include 'footer.html' ?>
			
			</div>

		</div>
	</body>
</html>

<?php
include_once $_SERVER[ 'DOCUMENT_ROOT' ].'../trace/api/LogRequest.php';
twatchLogRequest();
?>

<?php
if( isset($stmt)) { 
	mysqli_stmt_close($stmt);
}

mysqli_free_result($summaryResult);
mysqli_close($conn);
?>